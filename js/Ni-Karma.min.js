/* nikarma - script to parse data from the Ni_Karma.lua produced from the 
 * World of Warcraft Ni Karma addon from http://www.knights-who-say-ni.com/NKS
 * http://github.com/Mottie/nikarma
 *
 * Author: Rob G, aka Mottie (mottie.guildportal.com)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 *
 * v1.0 8/25/2010 Original version, posted to github
 */

(function($){$.fn.nikarma=function(n){var l=$.extend({},$.fn.nikarma.defaults,n);return this.each(function(){var j=$(this),h=$.meta?$.extend({},l,j.data()):l,d,g,k,m,o=function(a){var f="",c=a.length-h.tooltipShowsLast-2,e='<table><tr class="header"><th class="date">Date</th><th class="type">Type</th><th class="reason">Reason</th><th class="value">Value</th></tr>',b='<span class="title">'+a[a.length-1].fullname+"</span> (showing last "+h.tooltipShowsLast+" entries, click to show all)<br>"+e;for(d=
0;d<a.length-1;d++){k='<tr><td class="date">'+a[d].DT+'</td><td class="type">'+a[d].type+'</td><td class="reason">';e+=k;b+=d>c?k:"";g=a[d].reason;if(g.match("Hitem")){g=g.split("|");g=f='<a style="color:#'+g[1].slice(-6)+'" href="http://www.wowhead.com/item='+g[2].split(":")[1]+'">'+g[3].replace(/h\[|\]/g,"")+"</a>"}m=a[d].value<0?" negative":"";k=g+'</td><td class="value'+m+'">'+a[d].value+"</td></tr>";b+=d>c?k:"";e+=k}e+="</table>";b+="</table>";return[a[d],e,b,f]},q=function(a){var f,c="",e,b;
for(f in a)if(typeof a[f][0]!=="undefined"){b=o(a[f]);e=b[0].wowclass=="fixlocal"?h.fixClass[b[0].fullname]||"Unknown":b[0].wowclass;c+='<tr><td class="name">'+b[0].fullname+"</td>";c+='<td class="wowclass '+e.replace(/\s/g,"").toLowerCase()+'">'+e+"</td>";c+='<td class="lastitem">'+b[3]+"</td>";e=b[0].lifetime<0?" negative":"";c+='<td class="total tooltip'+e+'" data-popup="'+b[1].replace(/\"/g,"&quot;")+'" title="'+b[2].replace(/\"/g,"&quot;")+'">'+b[0].points+"</td></tr>"}if(c==="")j.hide().after('<div align="center">No Data Found!</div>');
else{j.find("tbody").append(c);j.find("table").tablesorter({textExtraction:function(i){return $(i).text()},sortList:[h.sortOrder]});j.find("td.total").click(function(){var i=$(this).closest("tr").find(".name").html(),p='<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"><html><head><link rel="stylesheet" href="'+$("link").attr("href")+'" type="text/css" ><title>'+i+'</title><script type="text/javascript" src="http://www.wowhead.com/widgets/power.js"><\/script></head><body>'+
$(this).attr("data-popup")+"</body></html>";i=window.open("",i,"width="+h.popupWidth+",height="+h.popupHeight+",scrollbars=1,resizable=1,toolbar=1,menubar=1,status=1");i.document.write(p);i.document.close()})}};$.ajax({url:h.nkFile,success:function(a){a=a.replace(/\]\s\=/g,":").replace(/[\t\r\n]/g,"").replace(/,\}/g,"}").replace(/\},/g,"}],").replace(/\],\s--\s\[\w+\]/g,",").replace(/,\[/g,",").replace(/\{\{\[/g,"[{").replace(/\{\[/g,"{").replace(/\}\}\]/g,"}]").replace(/\{\}\]/g,"{}").replace(/"lifetime"/g,
'{"lifetime"').replace(/class/g,"wowclass").replace(/\}\}\}/g,"}]}}}}").replace(/KarmaList\s\=/,"");if(a.lastIndexOf("KarmaConfig"))a=a.substring(0,a.lastIndexOf("KarmaConfig"));var f=$.parseJSON(a),c=h.database.split(".");for(a=0;a<c.length;a++)f=f[c[a]];q(f)},error:function(){j.html('<div align="center">No Data Found!</div>')}})})};$.fn.nikarma.defaults={nkFile:"Ni_Karma.lua",database:"Test.ICC.ICC25",tooltipShowsLast:5,popupWidth:500,popupHeight:450,sortOrder:[0,0],fixClass:[]}})(jQuery);
